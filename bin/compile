#!/bin/sh

BUILD_DIR=$1
DB_PATH="${1}/geolite/city.mmdb.gz"
DB_URL="http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz"

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

function db_download() {
  url="$1"
  location="$2"

  mkdir -p $location
  curl $url --location -s -o
}

if [ -f $DB_DEST_DIR ]; then
  echo "Database already exists. Skipping..." | indent
  exit 1
fi

echo "-----> Downloading city database..." |> indent
db_download "${DB_URL}" "${DB_PATH}"
echo "-----> Download complete..." |> indent

# city_checksum=$(curl http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.md5)
# country_checksum=$(curl http://geolite.maxmind.com/download/geoip/database/GeoLite2-Country.md5)
# echo "-----> Download complete. Verifying checksum..."

# city=$(cat ./geolite/city.mmdb.gz | md5sum)
# country=$(cat ./geolite/country.mmdb.gz | md5sum)
# echo $city_checksum
# echo $city
# echo $country_checksum
# echo $country


# if ! [ "$city" == "$city_checksum" ]; then
#   echo "-----> ERROR: city db checksums does not match"
# fi

# if ! [ "$country" == "$country_checksum" ]; then
#   echo "-----> ERROR: country db checksums does not match"
# fi